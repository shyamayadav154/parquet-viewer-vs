<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parquet Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <script>
    // Theme init before paint
    const storedTheme = localStorage.getItem('theme');
    if(storedTheme==='dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)){
      document.documentElement.classList.add('dark');
    }
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 8px; }
  .drop-active { border-color: rgb(99 102 241); background: rgba(238,242,255,0.6); }
  /* SQL autocomplete dropdown styling */
  #sqlAutocomplete { line-height:1.2; }
  #sqlAutocomplete button { display:block; width:100%; text-align:left; padding:4px 6px; background:transparent; border:0; cursor:pointer; color:#334155; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  :root.dark #sqlAutocomplete button { color:#cbd5e1; }
  #sqlAutocomplete button.active, #sqlAutocomplete button:hover { background:#e0e7ff; }
  :root.dark #sqlAutocomplete button.active, :root.dark #sqlAutocomplete button:hover { background:#312e81; }
  #sqlAutocomplete .sec-h { padding:4px 6px; font-size:10px; text-transform:uppercase; letter-spacing:.05em; font-weight:600; opacity:.65; cursor:default; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-slate-50 to-slate-100 dark:bg-none dark:bg-slate-900 text-slate-800 dark:text-slate-100 selection:bg-indigo-500/60 selection:text-white">
  <header class="backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-slate-900/70 bg-white/90 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-[1500px] mx-auto flex items-center justify-between px-6 h-14">
      <div class="flex items-center gap-2 font-semibold tracking-tight text-lg">
        <span class="inline-flex h-8 w-8 rounded-lg bg-indigo-600 text-white items-center justify-center shadow">P</span>
        <span>Parquet Viewer</span>
      </div>
  <div class="flex items-center gap-4">
        <button id="themeToggle" class="rounded-md px-3 py-1.5 text-sm font-medium border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
          <span class="light-label">Dark</span><span class="dark-label hidden">Light</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-[1500px] mx-auto px-6 pt-8 pb-32 space-y-10">
    <section class="space-y-4" id="uploadArea">
      <div id="uploaderCard" class="p-5 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 shadow-sm">
        <form id="uploadForm" class="space-y-4">
          <div class="flex flex-wrap gap-6 items-end">
            <div class="grow min-w-[260px]">
              <label class="block text-xs font-semibold uppercase tracking-wide mb-2 text-slate-600 dark:text-slate-400">Parquet File</label>
              <div id="dropZone" class="relative flex flex-col md:flex-row md:items-center gap-3 p-4 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl text-center md:text-left hover:border-indigo-400 dark:hover:border-indigo-500 transition cursor-pointer bg-slate-50/60 dark:bg-slate-800/40">
                <input id="file" name="file" type="file" accept=".parquet" class="absolute inset-0 opacity-0 cursor-pointer" required />
                <div class="text-3xl md:text-4xl">ðŸ“„</div>
                <div class="flex flex-col items-center md:items-start">
                  <p class="text-sm font-medium">Drag & drop or click to browse</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">Parquet (.parquet)</p>
                  <p id="fileName" class="mt-1 text-xs text-indigo-600 dark:text-indigo-400 hidden"></p>
                </div>
              </div>
            </div>
            <div class="flex gap-6 flex-wrap">
              <label class="flex items-center gap-2 text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                <input type="checkbox" name="include_stats" checked class="accent-indigo-600" /> Stats
              </label>
            </div>
            <div class="hidden" id="uploadBtnWrap">
              <button id="uploadBtn" class="inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-400 dark:disabled:bg-slate-700 text-white text-sm font-medium px-4 py-2 shadow transition">
                <span class="btn-text">Upload & Inspect</span>
                <span class="loading hidden animate-spin h-4 w-4 border-2 border-white/40 border-t-white rounded-full"></span>
              </button>
            </div>
          </div>
          <p class="text-xs text-slate-500 dark:text-slate-500">File uploads automatically when selected.</p>
        </form>
      </div>
    </section>
    <!-- File info section displayed after upload -->
    <div id="fileInfoSection" class="hidden">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 p-4 -mt-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 shadow-sm">
        <div class="flex items-center gap-4">
          <div class="h-12 w-12 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-xl font-semibold shadow">P</div>
          <div class="flex flex-col">
            <h3 id="fileInfoName" class="font-semibold text-sm md:text-base"></h3>
            <p id="fileInfoMeta" class="text-xs text-slate-500 dark:text-slate-400"></p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="removeFileBtn" class="text-xs font-medium px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 transition">Remove File</button>
        </div>
      </div>
    </div>
    <!-- Main two-tab container added below upload details -->
  <div id="mainTabContainer" class="space-y-6 hidden">
  <div class="border-b border-slate-200 dark:border-slate-800 flex items-center justify-between sticky top-0 z-30 bg-white/80 dark:bg-slate-900/70 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-slate-900/60 px-1" role="tablist">
    <div class="flex gap-6">
      <button data-main-tab="inspect" class="main-tab-btn active relative py-2 text-sm font-semibold text-indigo-600 dark:text-indigo-400">UI Filter</button>
      <button data-main-tab="second" class="main-tab-btn relative py-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400">SQL Filter</button>
    </div>
    <div class="flex">
      <button data-main-tab="stats" class="main-tab-btn relative py-2 pl-6 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400">Stats</button>
    </div>
      </div>
      <div id="main-tab-panels">
        <div id="main-panel-inspect" class="main-tab-panel">
          <!-- Existing results section moved inside first main tab -->
          <section class="space-y-6" id="resultsSection">
            <div id="placeholder" class="h-64 flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 bg-white/40 dark:bg-slate-900/40 text-slate-500 dark:text-slate-500">
              <div class="text-5xl">ðŸ§ª</div>
              <p class="font-medium">Upload a Parquet file to inspect its schema & data.</p>
            </div>
            <div id="resultWrapper" class="hidden space-y-6">
              <div class="flex flex-wrap items-center gap-4">
                <div class="relative flex items-center gap-3">
                  <button id="colToggle" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-1.5 text-xs font-medium hover:border-indigo-400 dark:hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition">Columns <span id="colCount" class="text-slate-500 dark:text-slate-400"></span> â–¾</button>
                  <div id="colMenu" class="hidden absolute left-0 top-full mt-2 z-40 w-64 max-h-72 overflow-auto rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg p-3 space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                      <input id="colSearch" type="text" placeholder="Search" class="w-full rounded-md border-slate-300 dark:border-slate-700 dark:bg-slate-800/60 px-2 py-1" />
                      <button id="colClear" class="text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400" title="Clear selection">âœ•</button>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] uppercase tracking-wide font-semibold text-slate-500 dark:text-slate-500 pt-1 pb-1 border-b border-slate-100 dark:border-slate-800">Select</div>
                    <div id="colList" class="space-y-1"></div>
                    <div class="flex justify-between pt-2 border-t border-slate-100 dark:border-slate-800 text-[11px]">
                      <button id="selectAll" class="text-indigo-600 dark:text-indigo-400 font-medium">All</button>
                      <button id="selectNone" class="text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400">None</button>
                      <button id="applyCols" class="px-2 py-0.5 rounded bg-indigo-600 text-white text-[11px] font-medium">Apply</button>
                    </div>
                  </div>
                  <div class="relative">
                    <button id="filterToggle" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-1.5 text-xs font-medium hover:border-emerald-400 dark:hover:border-emerald-500 hover:text-emerald-600 dark:hover:text-emerald-400 transition">Filter <span id="filterBadge" class="hidden text-emerald-600 dark:text-emerald-400">0</span> â–¾</button>
                    <div id="filterMenu" class="hidden absolute z-20 mt-2 w-[420px] max-h-[480px] overflow-auto rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg p-4 space-y-4 text-xs">
                      <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-slate-600 dark:text-slate-300 text-xs tracking-wide">Filters (AND)</h4>
                        <button id="addFilterCond" class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-emerald-600 text-white text-[11px] font-medium">+ Condition</button>
                      </div>
                      <div id="filterConditions" class="space-y-3"></div>
                      <div class="flex justify-between gap-2 pt-2 border-t border-slate-100 dark:border-slate-800">
                        <div class="flex gap-2">
                          <button id="applyFilter" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white font-medium text-[11px]">Apply</button>
                          <button id="clearFilter" class="px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-rose-400 hover:text-rose-600 dark:hover:text-rose-400 text-[11px]">Clear</button>
                        </div>
                        <button id="closeFilter" class="text-slate-500 hover:text-emerald-600 dark:hover:text-emerald-400 text-[11px]">Close</button>
                      </div>
                      <p class="text-[10px] text-slate-500 dark:text-slate-500 leading-relaxed">All conditions are combined with AND. Use contains for substring match. Null operators ignore value.</p>
                    </div>
                  </div>
                </div>
              </div>
              <div id="panel-sample" class="mt-2"></div>
            </div>
          </section>
        </div>
        <div id="main-panel-stats" class="main-tab-panel hidden">
          <section class="space-y-6" id="statsSection">
            <div id="statsPlaceholder" class="h-64 flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 bg-white/40 dark:bg-slate-900/40 text-slate-500 dark:text-slate-500">
              <div class="text-5xl">ðŸ“Š</div>
              <p class="font-medium">Upload a Parquet file to view column statistics.</p>
            </div>
            <div id="statsContent" class="hidden space-y-4"></div>
          </section>
        </div>
        <div id="main-panel-second" class="main-tab-panel hidden">
          <div class="space-y-4">
            <div class="p-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 text-xs text-slate-600 dark:text-slate-400">
              <div class="flex items-stretch gap-3">
                <div class="flex flex-col flex-1 gap-1">
                  <span class="font-semibold text-[11px] tracking-wide uppercase text-slate-500 dark:text-slate-400">SQL</span>
                  <div class="relative">
                    <textarea id="sqlExecQuery" rows="3" class="flex-1 w-full rounded-md border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800/60 px-2 py-1.5 font-mono text-[11px] leading-snug resize-y text-slate-800 dark:text-slate-200 placeholder:italic placeholder:text-slate-400 dark:placeholder:text-slate-500" placeholder="SELECT * FROM data"></textarea>
                    <div id="sqlAutocomplete" class="hidden absolute left-0 top-full mt-1 w-64 max-h-60 overflow-auto rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg text-[11px] font-mono z-50"></div>
                  </div>
                  <span id="sqlExecStatus" class="text-[10px] text-slate-500 dark:text-slate-500 h-4"></span>
                </div>
                <div class="flex flex-col gap-2 items-stretch w-[90px] shrink-0">
                  <button id="runSqlBtn" class="w-full px-2.5 py-1.5 rounded-md bg-emerald-600 text-white font-medium text-[10px] hover:bg-emerald-500" title="Run (Enter)">Run</button>
                  <button id="clearSqlBtn" class="w-full px-2.5 py-1.5 rounded-md border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-rose-400 hover:text-rose-600 dark:hover:text-rose-400 text-[10px]">Clear</button>
                </div>
              </div>
            </div>
            <div id="sqlResultPanel" class="p-3 rounded-lg border border-dashed border-slate-300 dark:border-slate-700 bg-white/40 dark:bg-slate-900/40 text-[11px] text-slate-500 dark:text-slate-500">Run a SQL query to see results here.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer removed as per user request -->

  <script>
    const $ = (q,ctx=document)=>ctx.querySelector(q);
    const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  const form = $('#uploadForm');
    const fileInput = $('#file');
    const fileNameEl = $('#fileName');
  const uploadBtn = $('#uploadBtn');
  const btnText = uploadBtn ? uploadBtn.querySelector('.btn-text') : null;
  const loading = uploadBtn ? uploadBtn.querySelector('.loading') : {classList:{toggle:()=>{}}};
    const dropZone = $('#dropZone');
    const placeholder = $('#placeholder');
    const resultWrapper = $('#resultWrapper');
    const panels = $('#tab-panels');

    function setLoading(state){
      if(uploadBtn){ uploadBtn.disabled = state; }
      loading.classList.toggle('hidden', !state);
      if(btnText) btnText.textContent = state ? 'Processing...' : 'Upload & Inspect';
      if(state){ dropZone.classList.add('opacity-60','pointer-events-none'); } else { dropZone.classList.remove('opacity-60','pointer-events-none'); }
    }

  // Removed inner sample/stats tab logic after elevating Stats to main tab.

    // Main (outer) tabs logic
    function activateMainTab(name){
      $$('.main-tab-btn').forEach(b=>{
        const active = b.dataset.mainTab===name;
        b.classList.toggle('active', active);
        b.classList.toggle('text-indigo-600', active);
        b.classList.toggle('dark:text-indigo-400', active);
        b.classList.toggle('text-slate-500', !active);
        b.classList.toggle('dark:text-slate-400', !active);
        b.classList.toggle('font-semibold', active);
        b.classList.toggle('font-medium', !active);
      });
      $$('.main-tab-panel').forEach(p=>p.classList.add('hidden'));
      const panel = document.getElementById('main-panel-'+name);
      if(panel) panel.classList.remove('hidden');
    }
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.main-tab-btn');
      if(!btn) return;
      activateMainTab(btn.dataset.mainTab);
    });
    // Ensure first tab visible on load
    activateMainTab('inspect');
    // Initialize default SQL query
    const sqlArea = document.getElementById('sqlExecQuery');
    if(sqlArea){
      sqlArea.value = 'SELECT * FROM data';
      // Auto run default after slight delay to ensure upload may not yet exist; only run if data loaded later.
    }
    // --- SQL Autocomplete Implementation ---
    const sqlAuto = document.getElementById('sqlAutocomplete');
  const SQL_KEYWORDS = ['SELECT','FROM','WHERE','GROUP BY','ORDER BY','LIMIT','AND','OR','AS','COUNT','AVG','SUM','MIN','MAX','DISTINCT','JOIN','LEFT JOIN','RIGHT JOIN','OUTER JOIN','ON','HAVING','OFFSET','LIKE','NOT','IN','BETWEEN','CASE','WHEN','THEN','ELSE','END'];
    let sqlAutoItems = [];
    let sqlAutoFiltered = [];
    let sqlAutoIndex = -1;
    function updateSqlAutocompleteSource(){
      const cols = fullData ? fullData.schema.map(s=>s.name) : [];
      const resultCols = sqlResult ? (sqlResult.columns || []) : [];
      const tables = ['data'];
      const set = new Set();
      SQL_KEYWORDS.forEach(k=>set.add(k));
      tables.forEach(t=>set.add(t));
      cols.forEach(c=>set.add(c));
      resultCols.forEach(c=>set.add(c));
      sqlAutoItems = Array.from(set);
    }
    function currentSqlToken(){
      if(!sqlArea) return {token:'', start:0, end:0};
      const text = sqlArea.value;
      const pos = sqlArea.selectionStart || 0;
      let start = pos - 1;
      const isChar = ch => /[A-Za-z0-9_\.]/.test(ch);
      while(start >= 0 && isChar(text[start])) start--; start++;
      let end = pos;
      while(end < text.length && isChar(text[end])) end++;
      return { token: text.slice(start,pos), start, end };
    }
    function hideSqlAutocomplete(){ if(!sqlAuto) return; sqlAuto.classList.add('hidden'); sqlAutoIndex=-1; }
    function showSqlAutocomplete(){ if(!sqlAuto) return; sqlAuto.classList.remove('hidden'); }
    function renderSqlAutocomplete(){
      if(!sqlAuto) return;
      if(!sqlAutoFiltered.length){ hideSqlAutocomplete(); return; }
      sqlAuto.innerHTML = sqlAutoFiltered.map((s,i)=>`<button type='button' data-i='${i}' class='${i===sqlAutoIndex?"active":""}' tabindex='-1'>${s}</button>`).join('');
      showSqlAutocomplete();
    }
    function applySqlAutocompleteChoice(idx){
      if(idx < 0 || idx >= sqlAutoFiltered.length) return;
      const choice = sqlAutoFiltered[idx];
      const { start } = currentSqlToken();
      const before = sqlArea.value.slice(0,start);
      const after = sqlArea.value.slice(sqlArea.selectionStart);
      const needsSpace = choice.match(/\s/) ? ' ' : ' ';
      sqlArea.value = before + choice + needsSpace + after;
      const newPos = (before + choice + needsSpace).length;
      sqlArea.focus();
      sqlArea.setSelectionRange(newPos,newPos);
      hideSqlAutocomplete();
    }
    function filterSqlAutocomplete(){
      updateSqlAutocompleteSource();
      const { token } = currentSqlToken();
      if(!token){ hideSqlAutocomplete(); return; }
      const upper = token.toUpperCase();
      sqlAutoFiltered = sqlAutoItems.filter(s=> s.toUpperCase().startsWith(upper) && s.toUpperCase() !== upper).slice(0,30);
      if(!sqlAutoFiltered.length){ hideSqlAutocomplete(); return; }
      sqlAutoIndex = 0;
      renderSqlAutocomplete();
    }
    if(sqlArea){
      sqlArea.addEventListener('input', ()=>{ filterSqlAutocomplete(); });
      sqlArea.addEventListener('keydown', (e)=>{
        // Ctrl/Cmd + Space explicit trigger (even if list hidden)
        if((e.ctrlKey || e.metaKey) && e.code === 'Space'){
          e.preventDefault();
          // Determine if cursor is inside SELECT list (after last SELECT and before following FROM)
          const textBefore = sqlArea.value.slice(0, sqlArea.selectionStart);
          const lower = textBefore.toLowerCase();
          const lastSelect = lower.lastIndexOf('select');
          let inSelectList = false;
          if(lastSelect !== -1){
            const afterSelect = lower.slice(lastSelect + 6); // content after 'select'
            const fromPos = afterSelect.indexOf(' from ');
            // Cursor is in select list if no FROM yet OR cursor before the FROM keyword
            if(fromPos === -1){
              inSelectList = true;
            } else {
              // Compute absolute position of that from
              const absFrom = lastSelect + 6 + fromPos;
              if(sqlArea.selectionStart <= absFrom) inSelectList = true;
            }
          }
          if(!inSelectList){
            // Outside select list: ignore ctrl+space per requirement
            hideSqlAutocomplete();
            return;
          }
          // Inside SELECT list: only show column suggestions (excluding already referenced columns)
          updateSqlAutocompleteSource();
          const cols = fullData ? fullData.schema.map(s=>s.name) : [];
          const resultCols = sqlResult ? (sqlResult.columns || []) : [];
          const allCols = Array.from(new Set([...cols, ...resultCols]));
          // Extract already typed columns within SELECT list segment
          let selectSegment = '';
          if(lastSelect !== -1){
            const afterSelectFull = textBefore.slice(lastSelect + 6); // actual case preserved
            const fromPosReal = afterSelectFull.toLowerCase().indexOf(' from ');
            selectSegment = fromPosReal === -1 ? afterSelectFull : afterSelectFull.slice(0, fromPosReal);
          }
          const usedCols = new Set(
            selectSegment
              .split(/[,\n]/)
              .map(s=>s.trim())
              .filter(s=>s.length>0)
              .map(s=>{
                // Remove aliases: pattern "col AS alias" or "col alias"
                const m = s.match(/^(\S+)(?:\s+AS\s+|\s+)[A-Za-z_][A-Za-z0-9_]*$/i);
                return m ? m[1] : s.split(/\s+AS\s+/i)[0];
              })
              .map(s=>s.replace(/[`"']/g,''))
          );
          const { token } = currentSqlToken();
          function notUsed(c){ return !usedCols.has(c); }
          if(token){
            const upperTok = token.toUpperCase();
            sqlAutoFiltered = allCols.filter(c=> c.toUpperCase().startsWith(upperTok) && notUsed(c)).slice(0,50);
          } else {
            sqlAutoFiltered = allCols.filter(notUsed).slice(0,50);
          }
          if(!sqlAutoFiltered.length){ hideSqlAutocomplete(); return; }
          sqlAutoIndex = 0; renderSqlAutocomplete();
          return;
        }
        if(sqlAuto.classList.contains('hidden')) return; // intercept only when open
        if(e.key === 'ArrowDown'){ e.preventDefault(); sqlAutoIndex = (sqlAutoIndex + 1) % sqlAutoFiltered.length; renderSqlAutocomplete(); }
        else if(e.key === 'ArrowUp'){ e.preventDefault(); sqlAutoIndex = (sqlAutoIndex - 1 + sqlAutoFiltered.length) % sqlAutoFiltered.length; renderSqlAutocomplete(); }
        else if(e.key === 'Enter' || e.key === 'Tab'){ if(sqlAutoIndex >= 0){ e.preventDefault(); applySqlAutocompleteChoice(sqlAutoIndex); } }
        else if(e.key === 'Escape'){ hideSqlAutocomplete(); }
      });
      sqlArea.addEventListener('click', ()=>{ filterSqlAutocomplete(); });
      document.addEventListener('click', (e)=>{ if(!sqlAuto.contains(e.target) && e.target !== sqlArea){ hideSqlAutocomplete(); }});
      sqlAuto.addEventListener('mousedown', (e)=>{ const btn = e.target.closest('button[data-i]'); if(!btn) return; e.preventDefault(); applySqlAutocompleteChoice(parseInt(btn.dataset.i,10)); });
    }
    // Press Enter to run, Shift+Enter for newline
    if(sqlArea){
      sqlArea.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){
          e.preventDefault();
          runSqlQuery();
        }
      });
    }

    function fmtNumber(n){
      return Intl.NumberFormat().format(n);
    }

    function renderTable(headers, rows, {selectable=false, prefix=''}={}){
      const master = selectable ? `<th class='px-2 py-2 font-semibold whitespace-nowrap w-6 sticky left-0 bg-slate-100/70 dark:bg-slate-800/60'><input id='${prefix}RowSelectAll' type='checkbox' class='accent-indigo-600 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-sm'/></th>` : '';
      const headHtml = headers ? `<thead class='bg-slate-100/70 dark:bg-slate-800/60 text-slate-600 dark:text-slate-300 sticky top-0'><tr>${master}${headers.map(h=>`<th class='px-3 py-2 font-semibold whitespace-nowrap'>${h}</th>`).join('')}</tr></thead>` : '';
      const body = rows.map((r,i)=>{
  const cb = selectable ? `<td class='px-2 py-1.5 align-top sticky left-0 bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm'><input data-row='${i}' data-prefix='${prefix}' type='checkbox' class='row-select accent-indigo-600 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-sm'/></td>` : '';
        return `<tr class='hover:bg-indigo-50/70 dark:hover:bg-indigo-900/30 transition'>${cb}${r.map(c=>`<td class='px-3 py-1.5 align-top whitespace-nowrap'>${c}</td>`).join('')}</tr>`;
      }).join('');
  return `<div class='overflow-x-auto overflow-y-auto rounded-xl ring-1 ring-slate-200 dark:ring-slate-800 shadow-sm max-h-[300px] w-full'><table class='text-[11px] md:text-sm text-left align-top w-max min-w-full'>${headHtml}<tbody class='divide-y divide-slate-100 dark:divide-slate-800 bg-white/60 dark:bg-slate-900/40'>${body}</tbody></table></div>`;
    }

    // --- Virtualization support ---
    // Store per-viewer state (selection + virtualization meta)
    const dataViewers = {}; // prefix -> {selected:Set<number>, rows:object[], headers:string[], virtual:boolean, rowHeight:number}

    function renderVirtualizedTable({headers, rowObjects, prefix}){
      const rowCount = rowObjects.length;
  const containerHeight = 300; // reduced height per user request
      const estRowHeight = 28; // px (approx, will refine after first measurement)
      if(!dataViewers[prefix]) dataViewers[prefix] = {selected:new Set(), rows:rowObjects, headers, virtual:true, rowHeight:estRowHeight};
      const state = dataViewers[prefix];
      state.rows = rowObjects; state.headers = headers; state.virtual = true;
      const master = `<th class='px-2 py-2 font-semibold whitespace-nowrap w-6 sticky left-0 bg-slate-100/70 dark:bg-slate-800/60'><input id='${prefix}RowSelectAll' type='checkbox' class='accent-indigo-600 border border-slate-300 dark:border-slate-600 rounded-sm'/></th>`;
      const headHtml = `<thead class='bg-slate-100/70 dark:bg-slate-800/60 text-slate-600 dark:text-slate-300 sticky top-0'><tr>${master}${headers.map(h=>`<th class='px-3 py-2 font-semibold whitespace-nowrap'>${h}</th>`).join('')}</tr></thead>`;
    return `<div id='${prefix}VirtualWrap' class='overflow-x-auto overflow-y-auto rounded-xl ring-1 ring-slate-200 dark:ring-slate-800 shadow-sm w-full' style='max-height:${containerHeight}px;'>
      <table class='text-[11px] md:text-sm text-left align-top w-max min-w-full'>${headHtml}<tbody id='${prefix}VirtualBody' class='bg-white/60 dark:bg-slate-900/40'></tbody></table>
    </div>`;
    }

    function updateVirtualRows(prefix){
      const state = dataViewers[prefix];
      if(!state || !state.virtual) return;
      const wrap = document.getElementById(prefix+'VirtualWrap');
      const body = document.getElementById(prefix+'VirtualBody');
      if(!wrap || !body) return;
      const scrollTop = wrap.scrollTop;
      const h = wrap.clientHeight;
      const rowH = state.rowHeight;
      const total = state.rows.length;
      const first = Math.max(0, Math.floor(scrollTop / rowH) - 5);
      const per = Math.ceil(h / rowH) + 10; // buffer
      const last = Math.min(total, first + per);
      const slice = state.rows.slice(first, last);
      const topPad = first * rowH;
      const bottomPad = (total - last) * rowH;
      const rowsHtml = slice.map((r, idx)=>{
        const realIndex = first + idx;
        const cbChecked = state.selected.has(realIndex) ? 'checked' : '';
        const cells = state.headers.map(h=>{
          const v = r[h];
          if(v===null||v===undefined) return '<td class=\'px-3 py-1.5 align-top whitespace-nowrap\'><span class="text-slate-400">null</span></td>';
          let s = typeof v==='object'? JSON.stringify(v): String(v);
          if(s.length>120) s = `<span title='${s.replace(/"/g,'&quot;')}'>${s.slice(0,117)}â€¦</span>`;
          return `<td class='px-3 py-1.5 align-top whitespace-nowrap'>${s}</td>`;
        }).join('');
        return `<tr data-r='${realIndex}' class='hover:bg-indigo-50/70 dark:hover:bg-indigo-900/30 transition'>
          <td class='px-2 py-1.5 align-top sticky left-0 bg-white/80 dark:bg-slate-900/60'><input data-row='${realIndex}' type='checkbox' class='row-select accent-indigo-600 border border-slate-300 dark:border-slate-600 rounded-sm' ${cbChecked}/></td>
          ${cells}
        </tr>`;
      }).join('');
      body.innerHTML = `<tr style='height:${topPad}px'></tr>${rowsHtml}<tr style='height:${bottomPad}px'></tr>`;
      // Refine row height using first real visible row
      const firstReal = body.querySelector('tr:nth-child(2)');
      if(firstReal){
        const measured = firstReal.getBoundingClientRect().height;
        if(measured && Math.abs(measured - state.rowHeight) > 2){
          state.rowHeight = measured;
          // Re-run to adjust paddings with new height
          updateVirtualRows(prefix);
          return;
        }
      }
      // Event binding for selection in virtual rows
      body.querySelectorAll('.row-select').forEach(cb=>{
        cb.addEventListener('change', (e)=>{
          const idx = parseInt(e.target.dataset.row,10);
          if(e.target.checked){ state.selected.add(idx);} else { state.selected.delete(idx);}          
          syncMasterCheckbox(prefix);
          updateSelectedCount(prefix);
          updateDataViewerSQL({headers: state.headers, rowObjects: state.rows, prefix});
        });
      });
    }

    function syncMasterCheckbox(prefix){
      const state = dataViewers[prefix]; if(!state) return;
      const master = document.getElementById(prefix+'RowSelectAll');
      if(!master) return;
      master.checked = state.selected.size && state.selected.size === state.rows.length;
      master.indeterminate = state.selected.size>0 && state.selected.size < state.rows.length;
    }

    function updateSelectedCount(prefix){
      const state = dataViewers[prefix]; if(!state) return;
      const box = document.getElementById(prefix+'selectedCount');
      if(box) box.value = `${state.selected.size}/${state.rows.length}`;
    }

    let fullData = null;
    let selectedCols = null; // null => all
  let activeFilters = []; // array of {id,col,op,value}

    function updateColCount(){
      const total = fullData ? fullData.schema.length : 0;
      const sel = selectedCols ? selectedCols.length : total;
      $('#colCount').textContent = `(${sel}/${total})`;
    }

    function buildColMenu(){
      if(!fullData) return;
      const list = $('#colList');
      const searchVal = $('#colSearch').value.toLowerCase();
      const cols = fullData.schema.map(s=>s.name).filter(n=>n.toLowerCase().includes(searchVal));
      list.innerHTML = cols.map(c=>{
        const checked = !selectedCols || selectedCols.includes(c);
        return `<label class='flex items-center gap-2 text-[11px] cursor-pointer'><input type='checkbox' data-col='${c}' ${checked?'checked':''} class='accent-indigo-600'/> <span class='truncate'>${c}</span></label>`;
      }).join('');
    }

    function applyColumnSelection(){
      if(!fullData) return;
      // null means "all columns"; empty array means none
      if(Array.isArray(selectedCols) && selectedCols.length===0){
        $('#panel-sample').innerHTML = `<p class='text-sm text-slate-500 dark:text-slate-400'>No columns selected.</p>`;
        $('#panel-stats').innerHTML = `<p class='text-sm text-slate-500 dark:text-slate-400'>No columns selected.</p>`;
        setColumnSelectionWarning();
        return;
      }
    const allCols = fullData.schema.map(s=>s.name);
    const sampleHead = selectedCols ? selectedCols.filter(c=>allCols.includes(c)) : allCols;
    let baseRows = fullData.sample;
    baseRows = activeFilters.length ? baseRows.filter(r=>activeFilters.every(f=>passFilter(r,f))) : baseRows;
    renderDataViewer({containerId:'panel-sample', headers: sampleHead, rowObjects: baseRows, prefix: 'sample-'});
      // Populate stats main panel
      const statsContent = document.getElementById('statsContent');
      const statsPlaceholder = document.getElementById('statsPlaceholder');
      if(fullData && fullData.stats && statsContent){
        const columnFilter = !selectedCols ? (c)=>true : (c)=>selectedCols.includes(c);
        const filteredStats = Object.entries(fullData.stats).filter(([c])=>columnFilter(c));
        const statCards = filteredStats.map(([col, stats])=>{
          return `<div class='p-2 rounded-lg ring-1 ring-slate-200 dark:ring-slate-800 bg-white/70 dark:bg-slate-900/50 flex flex-col gap-1 text-[11px] md:text-[11px] leading-tight'>
            <div class='flex items-center justify-between gap-2'>
              <h4 class='font-semibold text-[11px] truncate'>${col}</h4>
              <span class='text-[9px] uppercase tracking-wide text-slate-400 dark:text-slate-500'>${Object.keys(stats).length} fields</span>
            </div>
            <div class='flex flex-wrap gap-x-3 gap-y-1'>${Object.entries(stats).map(([k,v])=>`<span class='flex items-center gap-1'><span class='text-slate-500 dark:text-slate-500 uppercase text-[9px] tracking-wide'>${k}</span><span class='font-medium text-slate-700 dark:text-slate-200'>${v===null||v===undefined?'<span class="text-slate-400">â€“</span>':v}</span></span>`).join('')}</div>
          </div>`;
        }).join('');
        statsContent.innerHTML = statCards || `<p class='text-sm text-slate-500 dark:text-slate-400'>No stats for selected columns.</p>`;
        statsContent.classList.toggle('hidden', false);
        if(statsPlaceholder) statsPlaceholder.classList.add('hidden');
      }
      setColumnSelectionWarning();
    }

    function setColumnSelectionWarning(){
      const total = fullData ? fullData.schema.length : 0;
      const fullColumnNames = fullData ? fullData.schema.map(s=>s.name) : [];
      // Sample viewer subset logic (based on selectedCols)
      const sampleAll = !fullData ? true : (!selectedCols || selectedCols.length === total);
  const sampleSelectedCount = !fullData ? 0 : (!selectedCols ? total : selectedCols.length);
      const sampleStatus = document.getElementById('sample-sqlStatus');
      if(sampleStatus){
        if(!fullData){
          if(sampleStatus.dataset.warn==='1') delete sampleStatus.dataset.warn;
          sampleStatus.classList.remove('text-amber-600','dark:text-amber-400');
          if(!sampleStatus.textContent || sampleStatus.dataset.warn==='1') sampleStatus.textContent='';
        } else if(sampleAll){
          if(sampleStatus.dataset.warn==='1'){
            sampleStatus.textContent='';
            delete sampleStatus.dataset.warn;
            sampleStatus.classList.remove('text-amber-600','dark:text-amber-400');
          }
        } else {
          if(!sampleStatus.textContent || sampleStatus.dataset.warn==='1'){
    sampleStatus.textContent=`All columns are not selected (${sampleSelectedCount}/${total})`;
            sampleStatus.dataset.warn='1';
            sampleStatus.classList.add('text-amber-600','dark:text-amber-400');
          }
        }
      }
      // SQL result subset logic (compare sqlResult columns to full dataset schema)
      const sqlStatus = document.getElementById('sqlres-sqlStatus');
      if(sqlStatus){
        if(!fullData || !sqlResult){
          if(sqlStatus.dataset.warn==='1') delete sqlStatus.dataset.warn;
          sqlStatus.classList.remove('text-amber-600','dark:text-amber-400');
          if(!sqlStatus.textContent || sqlStatus.dataset.warn==='1') sqlStatus.textContent='';
        } else {
          const sqlCols = sqlResult.columns || [];
            // Determine if SQL result is a subset: missing any original columns
          const missing = fullColumnNames.filter(c=>!sqlCols.includes(c));
          const isSubset = missing.length>0;
          if(isSubset){
            if(!sqlStatus.textContent || sqlStatus.dataset.warn==='1'){
      sqlStatus.textContent=`All columns are not selected (${sqlCols.length}/${total})`;
              sqlStatus.dataset.warn='1';
              sqlStatus.classList.add('text-amber-600','dark:text-amber-400');
            }
          } else if(sqlStatus.dataset.warn==='1') {
            sqlStatus.textContent='';
            delete sqlStatus.dataset.warn;
            sqlStatus.classList.remove('text-amber-600','dark:text-amber-400');
          }
        }
      }
    }

    function renderResult(data){
      placeholder.classList.add('hidden');
      resultWrapper.classList.remove('hidden');
  // Filename & stats already shown in the file info card; avoid duplicate heading here.
      fullData = data;
      selectedCols = null; // all
      buildColMenu();
      updateColCount();
  populateFilterColumns();
  applyColumnSelection();
  updateSqlAutocompleteSource();
  // Stats are now a top-level tab; no inner tab activation needed.
  showFileInfoSection(data);
  // Hide uploader area now that file info is in the top bar
  const uploadArea = document.getElementById('uploadArea');
  if(uploadArea) uploadArea.classList.add('hidden');
      if(sqlArea && sqlArea.value.trim() && !sqlResult){ runSqlQuery(); }
  const mtc = document.getElementById('mainTabContainer');
  if(mtc) mtc.classList.remove('hidden');
    }

  async function handleUpload(){
      const data = new FormData(form);
      setLoading(true);
      try {
        const res = await fetch('/api/upload', { method:'POST', body: data });
        if(!res.ok){
          const t = await res.text();
          throw new Error(t);
        }
        const json = await res.json();
        renderResult(json);
      } catch(err){
        alert('Upload failed: '+err.message);
      } finally {
        setLoading(false);
      }
    }

    form.addEventListener('submit', e=>{ e.preventDefault(); });
    fileInput.addEventListener('change', ()=>{
      if(fileInput.files[0]){
        fileNameEl.textContent = fileInput.files[0].name + ' (' + Intl.NumberFormat().format(fileInput.files[0].size) + ' bytes)';
        fileNameEl.classList.remove('hidden');
        handleUpload(); // auto upload
      }
    });
  // Column menu interactions
  const colToggle = $('#colToggle');
  const colMenu = $('#colMenu');
  colToggle.addEventListener('click', (e)=>{ e.stopPropagation(); colMenu.classList.toggle('hidden'); buildColMenu(); });
  document.addEventListener('click', (e)=>{ if(!colMenu.contains(e.target) && e.target!==colToggle){ colMenu.classList.add('hidden'); }});
  $('#colSearch').addEventListener('input', buildColMenu);
  $('#selectAll').addEventListener('click', e=>{ e.preventDefault(); selectedCols=null; buildColMenu(); updateColCount(); });
  $('#selectNone').addEventListener('click', e=>{ e.preventDefault(); selectedCols=[]; buildColMenu(); updateColCount(); applyColumnSelection(); });
  $('#colClear').addEventListener('click', e=>{ e.preventDefault(); $('#colSearch').value=''; buildColMenu(); });
  $('#applyCols').addEventListener('click', e=>{ e.preventDefault(); const checks = $$('#colList input[type=checkbox]'); const all = fullData.schema.map(s=>s.name); const chosen = checks.filter(c=>c.checked).map(c=>c.dataset.col); selectedCols = chosen.length===all.length ? null : chosen; updateColCount(); applyColumnSelection(); colMenu.classList.add('hidden'); });
  $('#colList').addEventListener('change', e=>{ /* live updates optional */ });

    // Filter menu interactions
    const filterToggle = $('#filterToggle');
    const filterMenu = $('#filterMenu');
    const filterBadge = $('#filterBadge');
    const conditionsEl = $('#filterConditions');
    filterToggle.addEventListener('click', (e)=>{ e.stopPropagation(); filterMenu.classList.toggle('hidden'); });
    document.addEventListener('click', (e)=>{ if(!filterMenu.contains(e.target) && e.target!==filterToggle){ filterMenu.classList.add('hidden'); }});
    $('#closeFilter').addEventListener('click', ()=>filterMenu.classList.add('hidden'));
    $('#addFilterCond').addEventListener('click', (e)=>{ e.preventDefault(); addFilterCondition(); });
  $('#applyFilter').addEventListener('click', ()=>{ collectFilters(); updateFilterBadge(); filterMenu.classList.add('hidden'); applyColumnSelection(); });
  $('#clearFilter').addEventListener('click', ()=>{ activeFilters=[]; conditionsEl.innerHTML=''; updateFilterBadge(); filterMenu.classList.add('hidden'); applyColumnSelection(); });

    function populateFilterColumns(){
      if(!fullData) return;
      // Update existing selects
      $$('#filterConditions select[data-role=col]').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = fullData.schema.map(s=>`<option value='${s.name}'>${s.name}</option>`).join('');
        if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
      });
    }

    function addFilterCondition(){
      const id = crypto.randomUUID();
      const colsOptions = fullData ? fullData.schema.map(s=>`<option value='${s.name}'>${s.name}</option>`).join('') : '';
      const html = `<div class='cond flex items-end gap-2' data-id='${id}'>
        <label class='flex flex-col gap-1'>Col
          <select data-role='col' class='rounded-md border-slate-300 dark:border-slate-700 dark:bg-slate-800/60 px-2 py-1 text-[11px] min-w-[120px]'>${colsOptions}</select>
        </label>
        <label class='flex flex-col gap-1'>Op
          <select data-role='op' class='op-select rounded-md border-slate-300 dark:border-slate-700 dark:bg-slate-800/60 px-2 py-1 text-[11px]'>
            <option value='eq'>=</option>
            <option value='neq'>!=</option>
            <option value='gt'>&gt;</option>
            <option value='gte'>&gt;=</option>
            <option value='lt'>&lt;</option>
            <option value='lte'>&lt;=</option>
            <option value='contains'>contains</option>
            <option value='null'>is null</option>
            <option value='notnull'>is not null</option>
          </select>
        </label>
        <label class='flex flex-col gap-1 value-wrap'>Val
          <input data-role='val' type='text' class='rounded-md border-slate-300 dark:border-slate-700 dark:bg-slate-800/60 px-2 py-1 text-[11px] min-w-[120px]' />
        </label>
        <button data-role='remove' class='h-7 w-7 flex items-center justify-center rounded-md border border-slate-300 dark:border-slate-600 text-slate-500 hover:text-rose-600 hover:border-rose-400 dark:hover:text-rose-400 text-[13px]' title='Remove'>âœ•</button>
      </div>`;
      conditionsEl.insertAdjacentHTML('beforeend', html);
      const row = conditionsEl.lastElementChild;
      row.querySelector('[data-role=remove]').addEventListener('click', (e)=>{ e.preventDefault(); row.remove(); collectFilters(); updateFilterBadge(); applyColumnSelection(); });
      row.querySelector('.op-select').addEventListener('change', (e)=>{ toggleValueInput(row, e.target.value); });
    }

    function toggleValueInput(row, op){
      const wrap = row.querySelector('.value-wrap');
      if(!wrap) return;
      const hide = op==='null' || op==='notnull';
      wrap.classList.toggle('invisible', hide);
      wrap.classList.toggle('opacity-0', hide);
      if(hide){ row.querySelector('[data-role=val]').value=''; }
    }

    function collectFilters(){
      const result = [];
      $$('#filterConditions .cond').forEach(row=>{
        const col = row.querySelector('[data-role=col]').value;
        const op = row.querySelector('[data-role=op]').value;
        let value = row.querySelector('[data-role=val]').value;
        if(op==='null' || op==='notnull') value = null;
        if(!col) return;
        if((op!=='null' && op!=='notnull') && (value===null || value==='')) return;
        result.push({col, op, value});
      });
      activeFilters = result;
    }

    function updateFilterBadge(){
      filterBadge.textContent = activeFilters.length ? activeFilters.length : '0';
      filterBadge.classList.toggle('hidden', activeFilters.length===0);
    }

    function passFilter(row, f){
      const v = row[f.col];
      switch(f.op){
        case 'null': return v===null || v===undefined;
        case 'notnull': return v!==null && v!==undefined;
        case 'eq': return String(v)===f.value;
        case 'neq': return String(v)!==f.value;
        case 'gt': return typeof v==='number' ? v>Number(f.value) : String(v)>f.value;
        case 'gte': return typeof v==='number' ? v>=Number(f.value) : String(v)>=f.value;
        case 'lt': return typeof v==='number' ? v<Number(f.value) : String(v)<f.value;
        case 'lte': return typeof v==='number' ? v<=Number(f.value) : String(v)<=f.value;
        case 'contains': return v!==null && v!==undefined && String(v).toLowerCase().includes(f.value.toLowerCase());
        default: return true;
      }
    }
    ;['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.add('drop-active');}));
    ;['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault(); if(ev==='drop'){ const dt=e.dataTransfer; if(dt?.files?.length){ fileInput.files=dt.files; fileInput.dispatchEvent(new Event('change')); }} dropZone.classList.remove('drop-active');}));

    // Theme toggle
    const themeBtn = $('#themeToggle');
    function updateThemeBtn(){
      const dark = document.documentElement.classList.contains('dark');
      themeBtn.querySelector('.light-label').classList.toggle('hidden', dark);
      themeBtn.querySelector('.dark-label').classList.toggle('hidden', !dark);
    }
    themeBtn.addEventListener('click', ()=>{
      const el = document.documentElement;
      const dark = el.classList.toggle('dark');
      localStorage.setItem('theme', dark ? 'dark':'light');
      updateThemeBtn();
    });
    updateThemeBtn();

    // Inline file info section logic
    function showFileInfoSection(data){
      const section = document.getElementById('fileInfoSection');
      const nameEl = document.getElementById('fileInfoName');
      const metaEl = document.getElementById('fileInfoMeta');
      const removeBtn = document.getElementById('removeFileBtn');
      if(!section || !nameEl || !metaEl || !removeBtn) return;
      const sizeText = fileInput.files[0] ? ` Â· ${Intl.NumberFormat().format(fileInput.files[0].size)} bytes` : '';
      nameEl.textContent = data.filename;
      metaEl.textContent = `${fmtNumber(data.num_rows)} rows Â· ${data.num_columns} cols${sizeText}`;
      section.classList.remove('hidden');
      removeBtn.onclick = ()=>resetUpload();
    }

    function resetUpload(){
      fullData = null;
      selectedCols = null;
      resultWrapper.classList.add('hidden');
      placeholder.classList.remove('hidden');
  // Hide file info section
  const section = document.getElementById('fileInfoSection');
  if(section){ section.classList.add('hidden'); }
      // Reload page to restore original uploader state cleanly
      location.reload();
    }

    // SQL builder helpers
  function updateMaster(master, rowChecks){
      if(!master) return;
      const all = rowChecks.length && rowChecks.every(c=>c.checked);
      master.checked = all;
      const indeterminate = !all && rowChecks.some(c=>c.checked);
      master.indeterminate = indeterminate;
    }

    function escapeValue(v){
      if(v === null || v === undefined) return 'NULL';
      if(typeof v === 'number' || typeof v === 'boolean') return String(v);
      if(typeof v === 'object') v = JSON.stringify(v);
      return "'" + String(v).replace(/'/g, "''") + "'";
    }

    // Quote SQL identifiers for PostgreSQL compatibility (handles schema-qualified names)
    function quoteIdent(id){
      if(!id) return '""';
      // Allow schema.table or db.schema.table splitting on dots not inside quotes
      return id.split('.').map(part=> '"' + part.replace(/"/g,'""') + '"').join('.');
    }

    // Generic data viewer component with SQL builder
    function renderDataViewer({containerId, headers, rowObjects, prefix}){
      const container = document.getElementById(containerId);
      if(!container) return;
      // Build table rows content
      const tableRows = rowObjects.map(r=>headers.map(h=>{
        const v = r[h];
        if(v===null||v===undefined) return '<span class="text-slate-400">null</span>';
        const s = typeof v==='object'? JSON.stringify(v): String(v);
        return s.length>120? `<span title='${s.replace(/"/g,"&quot;") }'>${s.slice(0,117)}â€¦</span>`: s;
      }));
      const useVirtual = rowObjects.length > 1000; // threshold
      if(!dataViewers[prefix]) dataViewers[prefix] = {selected:new Set(), rows:rowObjects, headers, virtual:useVirtual, rowHeight:28};
      const state = dataViewers[prefix];
      state.virtual = useVirtual; state.rows = rowObjects; state.headers = headers;
      const tableHtml = useVirtual ? renderVirtualizedTable({headers, rowObjects, prefix}) : renderTable(headers, tableRows, {selectable:true, prefix});
      container.innerHTML = `
  <h4 class='mb-2 text-xs md:text-sm font-semibold tracking-wide uppercase text-slate-600 dark:text-slate-300'>Data</h4>
        <div class='flex items-center justify-between mb-2 gap-4'>
          <div class='flex items-center gap-2 order-1'>
            <button id='${prefix}selectAllRows' class='text-[11px] px-2 py-1 rounded-md border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-400'>Select All</button>
            <input id='${prefix}selectedCount' type='text' readonly value='0/0' title='Selected / Total rows' class='w-20 text-center text-[11px] px-1 py-0.5 cursor-default bg-transparent text-slate-500 dark:text-slate-500 focus:outline-none' />
          </div>
          <div id='${prefix}noRowsTop' class='hidden text-sm font-semibold text-rose-600 dark:text-rose-400 text-right order-2 flex-1'>select row to generate sql insert statement</div>
        </div>
        ${tableHtml}
        ${dataViewerBuilderSection(prefix)}
      `;
      attachDataViewerHandlers({container, headers, rowObjects, prefix});
      if(useVirtual){
        const wrap = document.getElementById(prefix+'VirtualWrap');
        if(wrap){
          wrap.addEventListener('scroll', ()=>{ updateVirtualRows(prefix); });
          updateVirtualRows(prefix); // initial
          syncMasterCheckbox(prefix); updateSelectedCount(prefix);
        }
      } else {
        // Restore previously selected rows (if any) when switching from virtual to non-virtual
        if(state.selected.size){
          state.selected.forEach(idx=>{
            const cb = container.querySelector(`.row-select[data-row='${idx}']`);
            if(cb) cb.checked = true;
          });
        }
      }
  // Initialize SQL builder UI state (show/hide messages appropriately)
  updateDataViewerSQL({headers, rowObjects, prefix});
    }

    function dataViewerBuilderSection(prefix){
      return `<div id='${prefix}sqlBuilder' class='mt-6 space-y-3'>
  <h4 class='text-xs md:text-sm font-semibold tracking-wide uppercase text-slate-600 dark:text-slate-300'>Generated SQL</h4>
        <div class='flex flex-wrap items-center gap-3'>
          <label id='${prefix}tableWrap' class='hidden text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400 flex items-center gap-2'>Table
            <input id='${prefix}sqlTableName' type='text' value='my_table' class='rounded-md border-slate-300 dark:border-slate-700 dark:bg-slate-800/60 text-xs px-2 py-1'/>
          </label>
          <label id='${prefix}perRowWrap' class='hidden flex items-center gap-1 text-[11px] font-medium text-slate-600 dark:text-slate-400'>
            <input id='${prefix}perRowMode' type='checkbox' class='accent-indigo-600' checked> Per-row
          </label>
          <button id='${prefix}copySql' class='hidden text-xs px-3 py-1.5 rounded-md bg-indigo-600 text-white font-medium'>Copy SQL</button>
          <button id='${prefix}downloadSql' class='hidden text-xs px-3 py-1.5 rounded-md bg-slate-600 text-white font-medium'>Download SQL</button>
          <span id='${prefix}sqlStatus' class='text-xs text-slate-500 dark:text-slate-500'></span>
        </div>
        <pre id='${prefix}sqlPreview' class='text-[10px] md:text-xs leading-relaxed bg-slate-50/90 dark:bg-slate-800/70 text-slate-800 dark:text-slate-100 p-3 rounded-lg ring-1 ring-slate-200 dark:ring-slate-700 overflow-auto max-h-64 hidden'></pre>
      </div>`;
    }

    function attachDataViewerHandlers({container, headers, rowObjects, prefix}){
      const state = dataViewers[prefix];
      const master = container.querySelector(`#${prefix}RowSelectAll`);
      const selectAllBtn = container.querySelector(`#${prefix}selectAllRows`);
      const selectedCountBox = container.querySelector(`#${prefix}selectedCount`);

      function updateSelectAllButton(){
        if(!selectAllBtn) return;
        const allSelected = state.selected.size && state.selected.size === rowObjects.length;
        selectAllBtn.textContent = allSelected ? 'Unselect All' : 'Select All';
      }
      function updateSelectedCount(){
        if(!selectedCountBox) return;
        const total = rowObjects.length;
        const sel = state.selected.size;
        selectedCountBox.value = `${sel}/${total}`;
      }
      if(master){
        master.addEventListener('change', ()=>{
          if(master.checked){
            // Select all
            state.selected = new Set(Array.from({length: rowObjects.length}, (_,i)=>i));
          } else {
            state.selected.clear();
          }
          if(state.virtual){ updateVirtualRows(prefix);} else { container.querySelectorAll('.row-select').forEach(c=>c.checked = master.checked); }
          updateDataViewerSQL({headers, rowObjects, prefix}); updateSelectAllButton(); updateSelectedCount();
        });
      }
      if(selectAllBtn){
        selectAllBtn.addEventListener('click', ()=>{
          const allSelected = state.selected.size === rowObjects.length;
          if(allSelected){ state.selected.clear(); }
          else { state.selected = new Set(Array.from({length: rowObjects.length}, (_,i)=>i)); }
          if(state.virtual){ updateVirtualRows(prefix);} else { container.querySelectorAll('.row-select').forEach(c=>c.checked = !allSelected); }
          syncMasterCheckbox(prefix); updateDataViewerSQL({headers, rowObjects, prefix}); updateSelectAllButton(); updateSelectedCount();
        });
      }
      // For non-virtual tables attach per-row listeners
      if(!state.virtual){
        container.querySelectorAll('.row-select').forEach(cb=>cb.addEventListener('change', (e)=>{
          const idx = parseInt(e.target.dataset.row,10);
          if(e.target.checked) state.selected.add(idx); else state.selected.delete(idx);
          if(master){
            const allSelected = state.selected.size === rowObjects.length;
            master.checked = allSelected; master.indeterminate = state.selected.size>0 && !allSelected;
          }
          updateDataViewerSQL({headers, rowObjects, prefix}); updateSelectAllButton(); updateSelectedCount();
        }));
      }
      updateSelectAllButton(); updateSelectedCount(); syncMasterCheckbox(prefix);
    container.querySelector(`#${prefix}copySql`)?.addEventListener('click', ()=>{
        const pre = container.querySelector(`#${prefix}sqlPreview`);
        navigator.clipboard.writeText(pre.textContent).then(()=>{
          const status = container.querySelector(`#${prefix}sqlStatus`);
          status.textContent = 'Copied!';
          setTimeout(()=>status.textContent='', 1500);
      // Reinstate warning if needed after copied message disappears
      setTimeout(()=>{ setColumnSelectionWarning(); }, 1550);
        });
      });
  // Download SQL handler
  container.querySelector(`#${prefix}downloadSql`)?.addEventListener('click', ()=>{
    const pre = container.querySelector(`#${prefix}sqlPreview`);
    if(!pre || !pre.textContent) return;
    const tableName = container.querySelector(`#${prefix}sqlTableName`)?.value || 'my_table';
    const blob = new Blob([pre.textContent], {type:'text/sql;charset=utf-8'});
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = `${tableName || 'query'}-${ts}.sql`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    const status = container.querySelector(`#${prefix}sqlStatus`);
    status.textContent = 'Downloaded!';
    setTimeout(()=>status.textContent='', 1500);
  });
      container.querySelector(`#${prefix}sqlTableName`)?.addEventListener('input', ()=>updateDataViewerSQL({headers, rowObjects, prefix}));
      container.querySelector(`#${prefix}perRowMode`)?.addEventListener('change', ()=>updateDataViewerSQL({headers, rowObjects, prefix}));
    }

    function updateDataViewerSQL({headers, rowObjects, prefix}){
      const pre = document.getElementById(`${prefix}sqlPreview`);
      const btn = document.getElementById(`${prefix}copySql`);
  const dlBtn = document.getElementById(`${prefix}downloadSql`);
      const topMsg = document.getElementById(`${prefix}noRowsTop`);
  if(!pre || !btn) return;
      const tableNameInput = document.getElementById(`${prefix}sqlTableName`);
  const tableInput = tableNameInput?.value || 'my_table';
  const table = quoteIdent(tableInput);
  const state = dataViewers[prefix];
  const selectedIdx = state ? Array.from(state.selected).sort((a,b)=>a-b) : [];
      if(selectedIdx.length===0){
        pre.classList.add('hidden');
        pre.textContent='';
        if(btn) btn.classList.add('hidden');
  if(dlBtn) dlBtn.classList.add('hidden');
        if(topMsg){
          topMsg.textContent='select row to generate sql insert statment';
          topMsg.classList.remove('hidden');
          topMsg.classList.remove('cursor-pointer','underline');
          topMsg.classList.remove('text-emerald-600','dark:text-emerald-400');
          topMsg.classList.add('text-rose-600','dark:text-rose-400');
          topMsg.onclick=null;
        }
        const tw = document.getElementById(`${prefix}tableWrap`);
        const pw = document.getElementById(`${prefix}perRowWrap`);
        if(tw) tw.classList.add('hidden');
        if(pw) pw.classList.add('hidden');
        return;
      }
      if(btn) btn.classList.remove('hidden');
  if(dlBtn) dlBtn.classList.remove('hidden');
      if(topMsg){
        topMsg.textContent='move to generated sql';
        topMsg.classList.remove('hidden');
        topMsg.classList.add('cursor-pointer','underline');
        topMsg.classList.remove('text-rose-600','dark:text-rose-400');
        topMsg.classList.add('text-emerald-600','dark:text-emerald-400');
        topMsg.onclick = ()=>{
          pre.classList.remove('hidden');
          pre.scrollIntoView({behavior:'smooth', block:'start'});
          // Swap out default grey ring for green highlight
          const removedClasses = ['ring-1','ring-slate-200','dark:ring-slate-700'];
          removedClasses.forEach(c=>pre.classList.remove(c));
          pre.classList.add('ring-2','ring-emerald-500');
          pre.style.transition = 'background-color 0.6s ease';
          if(!pre.dataset.origBg){ pre.dataset.origBg = pre.style.backgroundColor || ''; }
          pre.classList.add('bg-emerald-50','dark:bg-emerald-900/30');
          setTimeout(()=>{
            pre.classList.remove('ring-2','ring-emerald-500','bg-emerald-50','dark:bg-emerald-900/30');
            // Restore original ring classes
            pre.classList.add('ring-1','ring-slate-200','dark:ring-slate-700');
          }, 1400);
        };
      }
      const tw = document.getElementById(`${prefix}tableWrap`);
      const pw = document.getElementById(`${prefix}perRowWrap`);
      if(tw) tw.classList.remove('hidden');
      if(pw) pw.classList.remove('hidden');
      const perRow = document.getElementById(`${prefix}perRowMode`)?.checked;
      let sql;
      const quotedCols = headers.map(h=>quoteIdent(h));
      if(perRow){
        sql = selectedIdx.map(i=>{
          const rowObj = rowObjects[i];
          const vals = headers.map(h=>escapeValue(rowObj[h]));
          return `INSERT INTO ${table} (${quotedCols.join(', ')}) VALUES (${vals.join(', ')});`;
        }).join('\n');
      } else {
        const rowsSql = selectedIdx.map(i=>{
          const rowObj = rowObjects[i];
          const vals = headers.map(h=>escapeValue(rowObj[h]));
          return `  (${vals.join(', ')})`;
        }).join(',\n');
        sql = `INSERT INTO ${table} (\n  ${quotedCols.join(', ')}\n) VALUES\n${rowsSql};`;
      }
      pre.textContent = sql;
      pre.classList.remove('hidden');
    }

    let sqlResult = null; // {columns, rows, row_count}
  $('#runSqlBtn').addEventListener('click', ()=>runSqlQuery());
  $('#clearSqlBtn').addEventListener('click', ()=>{ clearSqlMode(); });

  async function runSqlQuery(){
      const query = $('#sqlExecQuery').value.trim();
      if(!query) return;
      if(!fullData){ alert('Upload a parquet file first.'); return; }
  // No longer clearing filters; they operate independently.
      sqlResult = null; applyColumnSelection();
      const status = $('#sqlExecStatus');
      status.textContent = 'Running...';
      try {
  const res = await fetch('/api/sql', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query})});
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();
    sqlResult = {columns: data.columns, rows: data.rows, row_count: data.row_count, stats: data.stats};
        status.textContent = `${data.row_count} rows (${data.columns.length} cols)`;
        applyColumnSelection();
        renderSqlResultPanel();
  updateSqlAutocompleteSource();
      } catch(err){
        status.textContent = 'Error';
        alert('SQL error: '+err.message);
      }
  // Mutually exclusive disabling removed
    }
    function clearSqlMode(){
  sqlResult = null; if($('#sqlExecQuery')) $('#sqlExecQuery').value=''; $('#sqlExecStatus').textContent=''; applyColumnSelection(); renderSqlResultPanel(); }

    function renderSqlResultPanel(){
      const panel = $('#sqlResultPanel');
      if(!panel){ return; }
      if(!sqlResult){ 
        // Keep placeholder styling for pre-query state
        panel.innerHTML = 'Run a SQL query to see results here.'; 
        // Ensure placeholder classes (in case they were removed after a prior run)
        panel.classList.add('p-3','rounded-lg','border','border-dashed','border-slate-300','dark:border-slate-700','bg-white/40','dark:bg-slate-900/40','text-[11px]','text-slate-500','dark:text-slate-500');
        return; 
      }
      const headers = sqlResult.columns;
  // Simplified: only show sample (no stats tab; stats are now only in top-level Stats tab)
  panel.className = 'space-y-4';
  panel.innerHTML = `<div id='sqlres-panel-sample'></div>`;
  renderDataViewer({containerId:'sqlres-panel-sample', headers, rowObjects: sqlResult.rows, prefix: 'sqlres-'});
  // Re-evaluate column subset warning for sql results
  setColumnSelectionWarning();
    }
  </script>
</body>
</html>
